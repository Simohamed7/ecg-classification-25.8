[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
lib_deps =
  links2004/WebSockets@^2.4.2
build_flags =
  -DCORE_DEBUG_LEVEL=1
firmware/src/main.cpp
#include <WiFi.h>
#include <WebSocketsServer.h>
#include <driver/adc.h>

const char* WIFI_SSID = "VOTRE_SSID";
const char* WIFI_PASS = "VOTRE_MDP";

#define ECG_PIN 34
#define LO_PLUS 32
#define LO_MINUS 33

WebSocketsServer ws(81);

const float FS = 250.0f; // Hz
const uint32_t DT_US = 4000; // 1/250s

// IIR HPF/LPF (1er ordre)
float hpf_y=0, hpf_x_prev=0, lpf_y=0;

float HPF(float x){
  const float fc=0.5f, dt=1.0f/FS; const float RC=1.0f/(2*PI*fc); const float a=RC/(RC+dt);
  float y = a*(hpf_y + x - hpf_x_prev);
  hpf_x_prev = x; hpf_y = y; return y;
}
float LPF(float x){
  const float fc=40.0f, dt=1.0f/FS; const float RC=1.0f/(2*PI*fc); const float b=dt/(RC+dt);
  lpf_y = lpf_y + b*(x - lpf_y); return lpf_y;
}

bool leadOff(){ pinMode(LO_PLUS,INPUT); pinMode(LO_MINUS,INPUT);
  return digitalRead(LO_PLUS)==HIGH || digitalRead(LO_MINUS)==HIGH; }

void setup(){
  Serial.begin(115200); delay(200);
  WiFi.mode(WIFI_STA); WiFi.begin(WIFI_SSID, WIFI_PASS);
  while(WiFi.status()!=WL_CONNECTED){ delay(300); Serial.print("."); }
  Serial.println(); Serial.print("IP: "); Serial.println(WiFi.localIP());
  ws.begin();
}

void loop(){
  static uint32_t t=0; ws.loop();
  uint32_t now = micros();
  if(now - t >= DT_US){ t += DT_US;
    int raw = analogRead(ECG_PIN);
    if(leadOff()){ ws.broadcastTXT("NaN"); return; }
    float x = (float)raw - 2048.0f; // centre
    float y = LPF(HPF(x));
    float yShift = y + 2048.0f; if(yShift<0) yShift=0; if(yShift>4095) yShift=4095;
    char buf[8]; itoa((int)(yShift+0.5f), buf, 10); ws.broadcastTXT(buf);
  }
}
